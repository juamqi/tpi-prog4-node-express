<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Búsquedas - TangoShop</title>
</head>
<body>
    <h1>Sistema de Búsquedas (5 endpoints)</h1>
    <p><a href="index.html">← Volver al inicio</a></p>
    
    <hr>
    
    <h2>1. GET /search/advanced - Búsqueda Avanzada</h2>
    <form id="advanced-search-form">
        <p>Término de búsqueda: <input type="text" name="query" required></p>
        <p>Buscar en:
            <select name="searchIn">
                <option value="both">Productos y Proveedores</option>
                <option value="products">Solo Productos</option>
                <option value="suppliers">Solo Proveedores</option>
            </select>
        </p>
        <fieldset>
            <legend>Filtros (Opcionales)</legend>
            <p>
                Categoría:
                <select name="categoryId" id="category-filter">
                    <option value="">-- Todas --</option>
                </select>
                <button type="button" onclick="loadCategoriesForFilter()">Cargar</button>
            </p>
            <p>Provincia: <input type="text" name="province"></p>
            <p>Precio Mínimo: <input type="number" name="minPrice" step="0.01"></p>
            <p>Precio Máximo: <input type="number" name="maxPrice" step="0.01"></p>
            <p>Rating Mínimo: <input type="number" name="minRating" step="0.1" min="0" max="5"></p>
        </fieldset>
        <button type="submit">Buscar</button>
    </form>
    
    <hr>
    
    <h2>2. GET /search/filters - Obtener Filtros Disponibles</h2>
    <button onclick="getSearchFilters()">Ver Filtros Disponibles</button>
    
    <hr>
    
    <h2>3. GET /search/products/:id/related - Productos Relacionados</h2>
    <form id="related-products-form">
        <p>
            Product ID:
            <input type="text" name="productId" id="related-product-id" required>
        </p>
        <p>
            <select id="product-select-related" onchange="selectProductForRelated()">
                <option value="">-- Seleccione un producto --</option>
            </select>
            <button type="button" onclick="loadProductsForRelated()">Cargar Productos</button>
        </p>
        <button type="submit">Ver Productos Relacionados</button>
    </form>
    
    <hr>
    
    <h2>4. GET /search/products/by-supplier/:supplierId - Productos por Proveedor</h2>
    <form id="products-by-supplier-form">
        <p>
            Supplier ID:
            <input type="text" name="supplierId" id="supplier-id-input" required>
        </p>
        <p>
            <select id="supplier-select" onchange="selectSupplier()">
                <option value="">-- Seleccione un proveedor --</option>
            </select>
            <button type="button" onclick="loadSuppliersForSearch()">Cargar Proveedores</button>
        </p>
        <button type="submit">Ver Productos del Proveedor</button>
    </form>
    
    <hr>
    
    <h2>5. GET /search/resellers/:id/favorite-suppliers - Proveedores Favoritos de Revendedor</h2>
    <p><strong>Requiere token de Reseller</strong></p>
    <form id="favorite-suppliers-form">
        <p>Reseller ID: <input type="text" name="resellerId" required></p>
        <p><em>Nota: Solo puedes ver tus propios proveedores favoritos</em></p>
        <button type="submit">Ver Proveedores Favoritos</button>
    </form>
    
    <hr>
    
    <h2>Respuesta del Servidor</h2>
    <pre id="response"></pre>
    
    <script>
        const BASE_URL = 'http://localhost:3000';
        
        function showResponse(data) {
            document.getElementById('response').textContent = JSON.stringify(data, null, 2);
        }
        
        function getResellerToken() {
            const token = localStorage.getItem('RESELLER_TOKEN');
            if (!token) {
                alert('Se requiere un token de Reseller');
                return null;
            }
            return token;
        }
        
        async function loadCategoriesForFilter() {
            try {
                const response = await fetch(`${BASE_URL}/categories?limit=50`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const select = document.getElementById('category-filter');
                    select.innerHTML = '<option value="">-- Todas --</option>';
                    result.data.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.categoryId;
                        option.textContent = category.name;
                        select.appendChild(option);
                    });
                    alert('Categorías cargadas');
                }
            } catch (error) {
                alert('Error al cargar categorías: ' + error.message);
            }
        }
        
        document.getElementById('advanced-search-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const params = new URLSearchParams();
            params.append('query', formData.get('query'));
            params.append('searchIn', formData.get('searchIn'));
            
            if (formData.get('categoryId')) params.append('filters[categoryId]', formData.get('categoryId'));
            if (formData.get('province')) params.append('filters[province]', formData.get('province'));
            if (formData.get('minPrice')) params.append('filters[minPrice]', formData.get('minPrice'));
            if (formData.get('maxPrice')) params.append('filters[maxPrice]', formData.get('maxPrice'));
            if (formData.get('minRating')) params.append('filters[minRating]', formData.get('minRating'));
            
            try {
                const response = await fetch(`${BASE_URL}/search/advanced?${params}`);
                const result = await response.json();
                showResponse(result);
            } catch (error) {
                showResponse({ error: error.message });
            }
        });
        
        async function getSearchFilters() {
            try {
                const response = await fetch(`${BASE_URL}/search/filters`);
                const result = await response.json();
                showResponse(result);
            } catch (error) {
                showResponse({ error: error.message });
            }
        }
        
        async function loadProductsForRelated() {
            try {
                const response = await fetch(`${BASE_URL}/products?limit=50`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const select = document.getElementById('product-select-related');
                    select.innerHTML = '<option value="">-- Seleccione un producto --</option>';
                    result.data.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.productId;
                        option.textContent = `${product.name} - $${product.price}`;
                        select.appendChild(option);
                    });
                    alert('Productos cargados');
                }
            } catch (error) {
                alert('Error al cargar productos: ' + error.message);
            }
        }
        
        function selectProductForRelated() {
            const select = document.getElementById('product-select-related');
            const input = document.getElementById('related-product-id');
            input.value = select.value;
        }
        
        document.getElementById('related-products-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const productId = formData.get('productId');
            
            try {
                const response = await fetch(`${BASE_URL}/search/products/${productId}/related`);
                const result = await response.json();
                showResponse(result);
            } catch (error) {
                showResponse({ error: error.message });
            }
        });
        
        async function loadSuppliersForSearch() {
            try {
                const response = await fetch(`${BASE_URL}/suppliers?limit=50`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const select = document.getElementById('supplier-select');
                    select.innerHTML = '<option value="">-- Seleccione un proveedor --</option>';
                    result.data.forEach(supplier => {
                        const option = document.createElement('option');
                        option.value = supplier.supplierId;
                        option.textContent = supplier.companyName;
                        select.appendChild(option);
                    });
                    alert('Proveedores cargados');
                }
            } catch (error) {
                alert('Error al cargar proveedores: ' + error.message);
            }
        }
        
        function selectSupplier() {
            const select = document.getElementById('supplier-select');
            const input = document.getElementById('supplier-id-input');
            input.value = select.value;
        }
        
        document.getElementById('products-by-supplier-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const supplierId = formData.get('supplierId');
            
            try {
                const response = await fetch(`${BASE_URL}/search/products/by-supplier/${supplierId}`);
                const result = await response.json();
                showResponse(result);
            } catch (error) {
                showResponse({ error: error.message });
            }
        });
        
        document.getElementById('favorite-suppliers-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = getResellerToken();
            if (!token) return;
            
            const formData = new FormData(e.target);
            const resellerId = formData.get('resellerId');
            
            try {
                const response = await fetch(`${BASE_URL}/search/resellers/${resellerId}/favorite-suppliers`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                showResponse(result);
            } catch (error) {
                showResponse({ error: error.message });
            }
        });
    </script>
</body>
</html>